# AISAC Agent Configuration

agent:
  # Agent ID (auto-generated if empty)
  id: ""
  # Labels for agent grouping/filtering
  labels:
    - production
    - webserver
  # Heartbeat interval
  heartbeat_interval: 30s
  # Initial reconnect delay
  reconnect_delay: 5s
  # Maximum reconnect delay
  max_reconnect_delay: 5m

server:
  # Enable SOAR functionality (receive commands from server)
  # Set to false to run in collector/heartbeat-only mode
  enabled: true
  # Command server WebSocket URL
  url: "wss://localhost:8443/ws"
  # Connection timeout
  connect_timeout: 30s
  # Write timeout
  write_timeout: 10s
  # Read timeout
  read_timeout: 60s

tls:
  # Enable mTLS
  enabled: true
  # Agent certificate
  cert_file: "/etc/aisac/certs/agent.crt"
  # Agent private key
  key_file: "/etc/aisac/certs/agent.key"
  # CA certificate
  ca_file: "/etc/aisac/certs/ca.crt"
  # Skip certificate verification (NOT RECOMMENDED)
  skip_verify: false

actions:
  # Enabled actions (only these will be executed)
  enabled:
    - block_ip
    - unblock_ip
    - isolate_host
    - unisolate_host
    - disable_user
    - enable_user
    - kill_process
    # - collect_forensics
    # - threat_hunt

  # Rate limits per action
  rate_limits:
    block_ip:
      max_per_minute: 10
      max_per_hour: 100
    isolate_host:
      max_per_minute: 1
      max_per_hour: 5
    disable_user:
      max_per_minute: 5
      max_per_hour: 50

  # Default action timeout
  default_timeout: 5m

# SOAR/n8n callback configuration
callback:
  # Enable callbacks to SOAR
  enabled: false
  # Webhook URL (n8n, SOAR platform, etc.)
  url: "https://n8n.example.com/webhook/aisac-callback"
  # Bearer token for authentication
  auth_token: ""
  # Request timeout
  timeout: 30s
  # Number of retry attempts on failure
  retry_attempts: 3
  # Delay between retries
  retry_delay: 5s
  # Skip TLS verification (NOT RECOMMENDED)
  skip_tls_verify: false

# Heartbeat configuration (status reporting to AISAC platform)
heartbeat:
  # Enable heartbeat reporting
  enabled: true
  # AISAC Platform heartbeat endpoint
  url: "https://api.aisac.cisec.es/v1/heartbeat"
  # API Key for authentication (format: aisac_xxxx...)
  # Get this from the AISAC Platform when registering this asset
  api_key: "aisac_your_api_key_here"
  # Asset ID (UUID from AISAC Platform)
  # This identifies the monitored asset in the platform
  asset_id: "your-asset-uuid-here"
  # Heartbeat interval (server can override via response)
  interval: 120s
  # Request timeout
  timeout: 10s
  # Skip TLS verification (NOT RECOMMENDED)
  skip_tls_verify: false

# Log collector configuration (SIEM functionality)
collector:
  # Enable log collection
  enabled: false

  # Tenant ID (OPTIONAL) - For multi-tenant environments
  # When using API Key authentication, the tenant is automatically
  # derived from the monitored_asset associated with the API Key.
  # Only set this if you need to override the automatic tenant detection.
  # tenant_id: ""

  # Log sources to collect
  sources:
    # Suricata EVE JSON logs
    - name: suricata
      type: file
      path: /var/log/suricata/eve.json
      parser: suricata_eve
      tags:
        - security
        - ids

    # System syslog
    - name: syslog
      type: file
      path: /var/log/syslog
      parser: syslog
      tags:
        - system

    # Generic JSON logs
    # - name: app_logs
    #   type: file
    #   path: /var/log/myapp/*.json
    #   parser: json
    #   tags:
    #     - application

  # Output configuration
  output:
    # Output type: http
    type: http
    # Ingest endpoint URL
    url: "https://api.aisac.cisec.es/v1/logs"
    # API Key for authentication (format: aisac_xxxx...)
    # Get this from the AISAC Platform when registering this asset
    api_key: "aisac_your_api_key_here"
    # Asset ID (UUID from AISAC Platform)
    asset_id: "your-asset-uuid-here"
    # Request timeout
    timeout: 30s
    # Number of retry attempts
    retry_attempts: 3
    # Delay between retries
    retry_delay: 5s
    # Skip TLS verification (NOT RECOMMENDED)
    skip_tls_verify: false

  # Batching configuration
  batch:
    # Number of events per batch
    size: 100
    # Maximum time before flushing (even if batch not full)
    interval: 5s

  # File reading configuration
  file:
    # Start position for new files: "end" or "beginning"
    start_position: end
    # Path to store file positions (for resume after restart)
    sincedb_path: /var/lib/aisac/sincedb.json

# Control plane protection (IPs/domains that should NEVER be blocked)
control_plane:
  # List of control plane IPs (AISAC server, SOAR platform, etc.)
  # These IPs will be protected from block_ip actions
  ips:
    - "10.0.0.1"      # AISAC server
    - "10.0.0.2"      # n8n/SOAR orchestrator
    # Add your control plane IPs here

  # List of control plane domains
  domains:
    - "api.aisac.cisec.es"
    - "n8n.example.com"

  # Enable whitelist protection
  always_allowed: true

# Safety mechanisms for destructive SOAR actions
safety:
  # Path to persist active action state (survives agent restarts)
  state_file: "/var/lib/aisac/safety_state.json"

  # Enable auto-revert: automatically revert destructive actions after TTL expires
  auto_revert_enabled: true

  # Default TTL for reversible actions (if not specified per-action)
  default_ttl: 1h

  # Per-action TTL overrides
  action_ttls:
    block_ip: 1h       # IP blocks auto-revert after 1 hour
    isolate_host: 30m  # Host isolation auto-reverts after 30 minutes
    disable_user: 2h   # User disables auto-revert after 2 hours

  # Heartbeat Auto-Recovery: if heartbeat fails consecutively, trigger recovery
  # This prevents the agent from being locked out if it loses connectivity
  heartbeat_failure_threshold: 5  # Number of consecutive failures before recovery

  # Actions to execute on heartbeat failure recovery
  # These are triggered automatically when the failure threshold is exceeded
  recovery_actions:
    - unisolate_host   # Restore network connectivity
    - unblock_all_ips  # Remove all IP blocks

logging:
  # Log level: debug, info, warn, error
  level: "info"
  # Log format: json, text
  format: "json"
  # Output: stdout, file
  output: "stdout"
  # Log file path (when output is "file")
  file: "/var/log/aisac/agent.log"
